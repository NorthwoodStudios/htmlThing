<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ER:LC Bot Settings</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #f0f4f8;
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 200px;
      background-color: #1e2a38;
      padding: 20px;
      box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3);
    }
    .sidebar h3 {
      margin-bottom: 20px;
      color: #aad4ff;
    }
    .sidebar button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: none;
      border-radius: 5px;
      background-color: #2c3e50;
      color: white;
      cursor: pointer;
      text-align: left;
    }
    .sidebar button:hover,
    .sidebar button.active {
      background-color: #3498db;
    }
    .content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }
    .page {
      display: none;
    }
    .page.active {
      display: block;
    }
    .setting {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #263545;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 8px;
    }
    .setting input,
    .setting button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background-color: #34495e;
      color: white;
      cursor: pointer;
      min-width: 80px;
      text-align: center;
    }
    .setting button:hover {
      background-color: #2980b9;
    }
    input[type="text"] {
      cursor: text;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h3>Settings</h3>
    <button class="tab active" onclick="showPage('general', event)">General</button>
    <button class="tab" onclick="showPage('automod', event)">Automod</button>
    <button class="tab" onclick="showPage('protection', event)">Server Protection</button>
    <button class="tab" onclick="showPage('logging', event)">Logging</button>
    <button class="tab" onclick="showPage('prefix', event)">Prefix</button>
  </div>

  <div class="content" id="content-area">
    <!-- General Page -->
    <div id="general" class="page active">
      <h2>General Settings</h2>
      <div class="setting">
        <span>Bot Status</span>
        <button 
          data-setting="bot_status" 
          data-guild="" 
          data-value="online"
          onclick="toggleButton(this)"
        >Online</button>
      </div>
      <div class="setting">
        <span>Command Prefix</span>
        <input 
          type="text" 
          placeholder="!" 
          data-setting="command_prefix" 
          data-guild="" 
          onblur="updateInput(this)"
        >
      </div>
    </div>

    <!-- Automod Page -->
    <div id="automod" class="page">
      <h2>Automod</h2>
      <div class="setting">
        <span>Anti-Spam</span>
        <button 
          data-setting="anti_spam" 
          data-guild="" 
          data-value="enabled" 
          onclick="toggleButton(this)"
        >Enabled</button>
      </div>
      <div class="setting">
        <span>Bad Word Filter</span>
        <button 
          data-setting="bad_word_filter" 
          data-guild="" 
          data-value="disabled" 
          onclick="toggleButton(this)"
        >Disabled</button>
      </div>
    </div>

    <!-- Server Protection Page -->
    <div id="protection" class="page">
      <h2>Server Protection</h2>
      <div class="setting">
        <span>Anti-Raid</span>
        <button 
          data-setting="anti_raid" 
          data-guild="" 
          data-value="enabled" 
          onclick="toggleButton(this)"
        >Enabled</button>
      </div>
      <div class="setting">
        <span>Kick on Bot Join</span>
        <button 
          data-setting="kick_on_bot_join" 
          data-guild="" 
          data-value="off" 
          onclick="toggleButton(this)"
        >Off</button>
      </div>
    </div>

    <!-- Logging Page -->
    <div id="logging" class="page">
      <h2>Logging</h2>
      <div class="setting">
        <span>Log Channel ID</span>
        <input 
          type="text" 
          placeholder="1234567890" 
          data-setting="log_channel_id" 
          data-guild="" 
          onblur="updateInput(this)"
        >
      </div>
      <div class="setting">
        <span>Log Bans</span>
        <button 
          data-setting="log_bans" 
          data-guild="" 
          data-value="on" 
          onclick="toggleButton(this)"
        >On</button>
      </div>
    </div>

    <!-- Prefix Page -->
    <div id="prefix" class="page">
      <h2>Prefix Settings</h2>
      <div class="setting">
        <span>Current Prefix</span>
        <input 
          type="text" 
          value="!" 
          data-setting="current_prefix" 
          data-guild="" 
          onblur="updateInput(this)"
        >
      </div>
      <div class="setting">
        <span>Reset to Default</span>
        <button onclick="resetPrefix(this)">Reset</button>
      </div>
    </div>
  </div>

 <script>
  // Show page function with event param to set active tab
  function showPage(id, event) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');

    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
  }

  // Capitalize helper
  function capitalizeFirstLetter(string) {
    return string.charAt(0).toUpperCase() + string.slice(1);
  }

  // Collect all current settings from the UI into a single object
  function collectAllSettings() {
    const settings = {};
    document.querySelectorAll('[data-setting]').forEach(el => {
      const key = el.dataset.setting;
      let val;
      if (el.tagName === 'BUTTON') {
        val = el.dataset.value || el.textContent.toLowerCase();
      } else if (el.tagName === 'INPUT') {
        val = el.value.trim();
      }
      settings[key] = val;
    });
    return settings;
  }

  // Apply settings object to UI controls
  function applySettings(settings) {
    for (const [key, val] of Object.entries(settings)) {
      const btn = document.querySelector(`button[data-setting="${key}"]`);
      const input = document.querySelector(`input[data-setting="${key}"]`);

      if (btn) {
        btn.dataset.value = val.toLowerCase();
        btn.textContent = capitalizeFirstLetter(val);
      }
      if (input) {
        input.value = val;
      }
    }
  }

  // Send all settings as one payload and update UI with response
  async function sendAllSettings(guild, updatedSetting, updatedValue) {
    if (!guild) {
      console.warn("Guild ID not set.");
      return;
    }

    // Update local settings object with the changed setting
    const allSettings = collectAllSettings();
    allSettings[updatedSetting] = updatedValue;

    const payload = {
      guild: guild,
      settings: allSettings
    };

    try {
      const res = await fetch('/update_setting', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        console.error('Failed to update settings');
        return;
      }

      const data = await res.json();
      if (data.success && data.settings) {
        applySettings(data.settings);
      } else {
        console.error('Unexpected response from server:', data);
      }
    } catch (err) {
      console.error('Error sending settings:', err);
    }
  }

  // Toggle button text and value, then send full update
  function toggleButton(btn) {
    const togglePairs = {
      "online": "offline",
      "offline": "online",
      "enabled": "disabled",
      "disabled": "enabled",
      "on": "off",
      "off": "on"
    };

    const currentVal = btn.dataset.value || btn.textContent.toLowerCase();
    const newVal = togglePairs[currentVal] || currentVal;

    btn.dataset.value = newVal;
    btn.textContent = capitalizeFirstLetter(newVal);

    const guild = btn.dataset.guild;
    const setting = btn.dataset.setting;

    sendAllSettings(guild, setting, newVal);
  }

  // On input blur, send full updated settings
  function updateInput(input) {
    const guild = input.dataset.guild;
    const setting = input.dataset.setting;
    const value = input.value.trim();
    sendAllSettings(guild, setting, value);
  }

  // Reset prefix to "!" and update
  function resetPrefix(btn) {
    const input = btn.closest('.page').querySelector('input[data-setting="current_prefix"]');
    if (input) {
      input.value = "!";
      updateInput(input);
    }
  }

  // On page load: fetch guild id from URL, set it on controls, load and apply settings
  async function init() {
    const params = new URLSearchParams(window.location.search);
    const guildId = params.get("Guild_Id");

    if (!guildId) {
      console.warn("No Guild_Id param in URL");
      return;
    }

    // Set data-guild attribute on all buttons and inputs
    document.querySelectorAll('button[data-setting], input[data-setting]').forEach(el => {
      el.dataset.guild = guildId;
    });

    try {
      const res = await fetch(`/get_guild_settings?guild_id=${guildId}`);
      if (!res.ok) throw new Error("Failed to load guild settings");

      const data = await res.json();
      if (data.success && data.settings) {
        applySettings(data.settings);
      } else {
        console.error('Failed to get valid settings from server', data);
      }
    } catch (err) {
      console.error(err);
    }
  }

  window.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
