<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Settings Panel</title>
<style>
  body {
    background: #1a1a1a;
    color: #00bcd4;
    font-family: Arial, sans-serif;
    margin: 0;
    display: flex;
  }
  nav.sidebar {
    width: 260px;
    background: #263238;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
    height: 100vh;
  }
  nav.sidebar .section h3 {
    cursor: pointer;
    user-select: none;
    margin-top: 0;
    padding-bottom: 5px;
    border-bottom: 1px solid #00bcd4;
  }
  nav.sidebar .section ul {
    list-style: none;
    padding-left: 0;
    margin: 0 0 15px 0;
    display: none;
  }
  nav.sidebar .section ul.show {
    display: block;
  }
  nav.sidebar li {
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 6px;
  }
  nav.sidebar li.active,
  nav.sidebar li:hover {
    background: #00bcd4;
    color: #263238;
  }
  #content {
    flex: 1;
    padding: 40px;
    box-sizing: border-box;
  }
  #section-title {
    font-size: 28px;
    margin-bottom: 20px;
  }
  .setting-card {
    background: #37474f;
    padding: 20px;
    border-radius: 12px;
    max-width: 500px;
  }
  .setting-card span {
    display: block;
    margin-bottom: 12px;
    font-weight: bold;
    font-size: 18px;
  }
  .setting-card input[type="text"] {
    background: #263238;
    color: #00bcd4;
    border: 1px solid #00bcd4;
    border-radius: 8px;
    padding: 8px;
    width: 100%;
    font-size: 16px;
    box-sizing: border-box;
  }
  .setting-card button {
    background: #00bcd4;
    border: none;
    border-radius: 8px;
    color: #263238;
    font-weight: bold;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
  }
  .setting-card button:hover {
    background: #0097a7;
  }
</style>
</head>
<body>

<nav class="sidebar">
  <div class="section">
    <h3>Bot Settings</h3>
    <ul>
      <li data-key="bot_status">Bot Status</li>
      <li data-key="prefix">Prefix</li>
      <li data-key="staff_roles">Staff Roles</li>
      <li data-key="management_roles">Management Roles</li>
      <li data-key="quota">Quota</li>
      <li data-key="types">Types</li>
      <li data-key="reset">Reset</li>
      <li data-key="main_logs">Main Logs</li>
      <li data-key="shift_logs">Shift Logs</li>
      <li data-key="punishment_logs">Punishment Logs</li>
      <li data-key="log_bans">Log Bans</li>
      <li data-key="command_logs">Command Logs</li>
      <li data-key="server_logs">Server Logs</li>
      <li data-key="more_later">More Later</li>
    </ul>
  </div>
</nav>

<div id="content">
  <h1 id="section-title">Loading...</h1>
  <div id="settings-container"></div>
</div>

<script>
  const toggleValues = {
    "on": "off", "off": "on",
    "enabled": "disabled", "disabled": "enabled",
    "true": "false", "false": "true"
  };

  const settingsSchema = {
    bot_status: "button",
    prefix: "input",
    staff_roles: "input",
    management_roles: "input",
    quota: "input",
    types: "input",
    reset: "button",
    main_logs: "button",
    shift_logs: "button",
    punishment_logs: "button",
    log_bans: "button",
    command_logs: "button",
    server_logs: "button",
    more_later: "button"
  };

  let guildId = null;
  let currentSettings = {};
  let currentSettingKey = null;

  function getGuildIdFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get("guild");
  }

  function toggleSection(header) {
    const ul = header.nextElementSibling;
    if (ul) ul.classList.toggle("show");
  }

  function highlightSelected(li) {
    document.querySelectorAll('nav.sidebar li').forEach(item => item.classList.remove("active"));
    li.classList.add("active");
  }

  function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  function getDefaultForType(type) {
    return type === "input" ? "" : "off";
  }

  function getDefaultSettings() {
    const defaults = {};
    for (const [key, type] of Object.entries(settingsSchema)) {
      defaults[key] = getDefaultForType(type);
    }
    return defaults;
  }

  async function sendAllSettings() {
    if (!guildId) return;

    const payload = {
      guild: guildId,
      settings: currentSettings
    };

    try {
      const res = await fetch("https://7a2d6734-4cb7-4aa8-b495-7264d7fca21c-00-1idxr1hkn6v2d.janeway.replit.dev:8080/update_setting", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        console.warn("Failed to update settings:", res.status);
      }
    } catch (e) {
      console.error("Error sending settings:", e);
    }
  }

  async function loadAllSettings() {
    if (!guildId) return;

    try {
      const res = await fetch(`https://7a2d6734-4cb7-4aa8-b495-7264d7fca21c-00-1idxr1hkn6v2d.janeway.replit.dev:8080/get_settings?guild=${guildId}`);
      if (!res.ok) {
        console.warn("Failed to load settings: Server returned", res.status);
        currentSettings = getDefaultSettings();
        return;
      }

      const json = await res.json();
      console.log("Loaded settings:", json);
      currentSettings = { ...getDefaultSettings(), ...json };
    } catch (e) {
      console.error("Error fetching settings:", e);
      currentSettings = getDefaultSettings();
    }
  }

  async function createSettingElement(key, value) {
    const card = document.createElement("div");
    card.className = "setting-card";

    const label = document.createElement("span");
    label.textContent = key.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
    card.appendChild(label);

    if (value === null || value === undefined) value = "";
    if (typeof value !== "string" && !Array.isArray(value)) value = String(value);

    if (key === "staff_roles" || key === "management_roles") {
      // Multi-select dropdown for roles

      let selectedRoles = [];
      if (Array.isArray(value)) {
        selectedRoles = value;
      } else if (typeof value === "string" && value.length > 0) {
        selectedRoles = value.split(",").map(r => r.trim()).filter(r => r.length > 0);
      }

      const select = document.createElement("select");
      select.multiple = true;
      select.style.minWidth = "200px";
      select.style.height = "120px";
      select.style.backgroundColor = "#263238";
      select.style.color = "#00bcd4";
      select.style.border = "1px solid #00bcd4";
      select.style.borderRadius = "8px";
      select.style.padding = "6px";

      card.appendChild(select);

      try {
        if (!guildId) throw new Error("Guild ID missing");
        const res = await fetch(`https://7a2d6734-4cb7-4aa8-b495-7264d7fca21c-00-1idxr1hkn6v2d.janeway.replit.dev:8080/get_roles?guild=${guildId}`);
        if (!res.ok) throw new Error("Failed to fetch roles");
        const roles = await res.json();

        roles.forEach(role => {
          const option = document.createElement("option");
          option.value = role.id;
          option.textContent = role.name;
          if (selectedRoles.includes(role.id) || selectedRoles.includes(role.name)) {
            option.selected = true;
          }
          select.appendChild(option);
        });
      } catch (e) {
        console.error("Error loading roles:", e);
      }

      select.onchange = () => {
        const selected = Array.from(select.selectedOptions).map(opt => opt.value);
        currentSettings[key] = selected;
        sendAllSettings();
      };

    } else if (settingsSchema[key] === "button") {
      const btn = document.createElement("button");
      btn.textContent = capitalize(value);
      btn.onclick = () => {
        const newVal = toggleValues[value.toLowerCase()] || value;
        btn.textContent = capitalize(newVal);
        currentSettings[key] = newVal;
        value = newVal;
        sendAllSettings();
      };
      card.appendChild(btn);

    } else if (settingsSchema[key] === "input") {
      const input = document.createElement("input");
      input.type = "text";
      input.value = value;
      input.onblur = () => {
        currentSettings[key] = input.value;
        sendAllSettings();
      };
      card.appendChild(input);

    } else {
      const spanVal = document.createElement("span");
      spanVal.textContent = value;
      card.appendChild(spanVal);
    }

    return card;
  }

  function renderSetting(key) {
    const container = document.getElementById("settings-container");
    container.innerHTML = "";

    const sectionTitle = document.getElementById("section-title");
    sectionTitle.textContent = key.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());

    let value = currentSettings[key];
    if (value === undefined) value = getDefaultForType(settingsSchema[key]);

    createSettingElement(key, value).then(el => {
      container.appendChild(el);
    });
  }

  async function onSidebarClick(e) {
    const li = e.target.closest("li");
    if (!li) return;

    highlightSelected(li);
    currentSettingKey = li.dataset.key;

    await loadAllSettings();
    renderSetting(currentSettingKey);
  }

  function initSidebar() {
    document.querySelectorAll("nav.sidebar .section h3").forEach(h3 => {
      h3.addEventListener("click", () => toggleSection(h3));
    });

    const firstUl = document.querySelector("nav.sidebar .section ul");
    if (firstUl) firstUl.classList.add("show");

    document.querySelectorAll("nav.sidebar li").forEach(li => {
      li.addEventListener("click", onSidebarClick);
    });
  }

  async function main() {
    guildId = getGuildIdFromURL();
    if (!guildId) {
      alert("Guild ID not found in URL.");
      console.error("Missing 'guild' parameter in URL.");
      return;
    }

    initSidebar();

    const firstLi = document.querySelector("nav.sidebar li");
    if (firstLi) {
      highlightSelected(firstLi);
      currentSettingKey = firstLi.dataset.key;
      await loadAllSettings();
      renderSetting(currentSettingKey);
    } else {
      console.warn("No settings found in sidebar.");
    }
  }

  main();
</script>

</body>
</html>
