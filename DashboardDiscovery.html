<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Discovery</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #eee;
      padding: 20px;
    }
    .guild {
      background: #222;
      margin: 10px 0;
      padding: 10px;
      border-radius: 6px;
      display: flex;
      align-items: center;
    }
    .guild-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      margin-right: 12px;
      background: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      color: #aaa;
      overflow: hidden;
    }
    .guild-icon img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 12px;
    }
  </style>
</head>
<body>
  <h1>Dashboard Discovery</h1>
  <div id="content">Loading...</div>

  <script>
    const BACKEND_URL = 'https://backend-js-3uce.onrender.com'; // Change this to your backend URL in production

    // Helper to get query param
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    async function fetchSessionData(sessionToken) {
      try {
        const res = await fetch(`${BACKEND_URL}/session/${sessionToken}`);
        if (!res.ok) throw new Error('Session not found or expired');
        return await res.json();
      } catch (err) {
        throw err;
      }
    }

    function createGuildElement(guild) {
      const div = document.createElement('div');
      div.className = 'guild';

      const iconDiv = document.createElement('div');
      iconDiv.className = 'guild-icon';

      if (guild.icon) {
        const img = document.createElement('img');
        img.src = `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png`;
        img.alt = `${guild.name} icon`;
        iconDiv.appendChild(img);
      } else {
        iconDiv.textContent = guild.name.charAt(0).toUpperCase();
      }

      const infoDiv = document.createElement('div');
      infoDiv.textContent = guild.name;

      div.appendChild(iconDiv);
      div.appendChild(infoDiv);

      return div;
    }

    async function main() {
      const sessionToken = getQueryParam('session');
      const content = document.getElementById('content');

      if (!sessionToken) {
        content.innerHTML = `<p>No session token found. Please <a href="${BACKEND_URL}/login" style="color:lightblue;">login</a>.</p>`;
        return;
      }

      try {
        const data = await fetchSessionData(sessionToken);

        content.innerHTML = `
          <h2>Welcome, ${data.user.username}#${data.user.discriminator}</h2>
          <p>Your servers:</p>
        `;

        if (data.guilds.length === 0) {
          content.innerHTML += `<p>You are not an admin of any servers.</p>`;
          return;
        }

        data.guilds.forEach(guild => {
          // Filter to only show guilds where user has admin perms
          const ADMIN_BIT = 0x8;
          if ((guild.permissions & ADMIN_BIT) === ADMIN_BIT) {
            const guildElem = createGuildElement(guild);
            content.appendChild(guildElem);
          }
        });
      } catch (err) {
        content.innerHTML = `<p>Error: ${err.message}. <a href="${BACKEND_URL}/login" style="color:lightblue;">Login again</a></p>`;
      }
    }

    main();
  </script>
</body>
</html>
